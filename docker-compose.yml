services:
  # MongoDB Database
  mongodb:
    image: mongo:7-jammy
    container_name: chat-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
    volumes:
      - mongodb_data:/data/db
    networks:
      - chat-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: chat-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - chat-network

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: chat-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672" # AMQP port
      - "15672:15672" # Management UI port
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: password123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - chat-network

  # User Service
  user-service:
    build:
      context: ./backend/user
      dockerfile: Dockerfile
    container_name: chat-user-service
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - MONGO_URI=mongodb+srv://swayam:swayam@cluster0.bsof52s.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0
      - PORT=5000
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=admin
      - RABBITMQ_PASSWORD=password123
      - JWT_SECRET=god-is-good-god-is-great
    depends_on:
      mongodb:
        condition: service_started
      redis:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./backend/user:/app
      - /app/node_modules
    networks:
      - chat-network

  # Mail Service
  mail-service:
    build:
      context: ./backend/mail
      dockerfile: Dockerfile
    container_name: chat-mail-service
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      - PORT=5001
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=admin
      - RABBITMQ_PASSWORD=password123
      - EMAIL_USER="swarag6900@gmail.com"
      - EMAIL_PASSWORD="lvlngokqoztxjddb"
    depends_on:
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./backend/mail:/app
      - /app/node_modules
    networks:
      - chat-network

  # Chat Service
  chat-service:
    build:
      context: ./backend/chat
      dockerfile: Dockerfile
    container_name: chat-chat-service
    restart: unless-stopped
    ports:
      - "5002:5002"
    environment:
      - PORT=5002
      - MONGO_URI=mongodb+srv://swayam:swayam@cluster0.bsof52s.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0
      - JWT_SECRET=god-is-good-god-is-great
      - USER_SERVICE_URL=http://user-service:5000/api/v1
      - CLOUDINARY_CLOUD_NAME=dnrfzgcrp
      - CLOUDINARY_API_KEY=659381931425234
      - CLOUDINARY_API_SECRET=ekW9f7cKaOJuPD7KjpamIkiSMeQ
    depends_on:
      mongodb:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      user-service:
        condition: service_started
    volumes:
      - ./backend/chat:/app
      - /app/node_modules
    networks:
      - chat-network

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: chat-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # For browser requests (NEXT_PUBLIC_ variables)
      - NEXT_PUBLIC_USER_SERVICE_URL=http://localhost:5000/api/v1
      - NEXT_PUBLIC_CHAT_SERVICE_URL=http://localhost:5002/api/v1
      - NEXT_PUBLIC_SOCKET_URL=http://localhost:5002
      # For server-side requests (if any)
      - USER_SERVICE_URL=http://user-service:5000/api/v1
      - CHAT_SERVICE_URL=http://chat-service:5002/api/v1
    depends_on:
      user-service:
        condition: service_started
      chat-service:
        condition: service_started
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    networks:
      - chat-network

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:

networks:
  chat-network:
    driver: bridge
